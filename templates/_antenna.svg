{% set wg = results.wg_mm %}
{% set lg = results.lg_mm %}
{% set wp = results.wp_mm %}
{% set lp = results.lp_mm %}
{% set wf = results.wf_mm %}
{% set lf = results.lf_mm %}
{% set h_mm = 1.6 %}
{% set labels_on = show_labels if show_labels is defined else True %}

{# nilai bawah: sisa ground di kiri/kanan feedline (bukan Wg total) #}
{% set wg_side = (wg - wf)/2 %}

{# Pastikan (lp+lf) muat di board saat digambar #}
{% set lg_draw = lg if lg > (lp + lf + 6*h_mm) else (lp + lf + 6*h_mm) %}

{# Canvas #}
{% set canvas_w = 560 %}
{% set canvas_h = 380 %}
{% set pad = 44 %}

{# Scale board agar muat canvas #}
{% set sx = (canvas_w - 2*pad) / wg %}
{% set sy = (canvas_h - 2*pad) / lg_draw %}
{% set s = sx if sx < sy else sy %}

{# Outer board (substrate/groundplane) #}
{% set bx = (canvas_w - wg*s) / 2 %}
{% set by = (canvas_h - lg_draw*s) / 2 %}

{# Conductor placement #}
{% set m = 3*h_mm %}
{% set top_gap = m %}
{% set left_gap = (wg - wp)/2 %}

{# Patch rectangle (main) #}
{% set px = bx + left_gap*s %}
{% set py = by + top_gap*s %}
{% set pw = wp*s %}
{% set ph = lp*s %}

{# Feed stem height #}
{% set fh = lf*s %}

{# === IMPORTANT FIX: stem width too thin -> enforce minimum pixel width === #}
{% set wf_px = wf*s %}
{% set fw_draw = wf_px if wf_px >= 50 else 50 %}   {# min 22px biar nggak terlalu tipis #}

{# Stem centered using fw_draw #}
{% set fx = bx + (wg*s - fw_draw)/2 %}
{% set fy = py + ph %}  

{# Bottom segmented dimensions using fw_draw (so WF segment matches yellow stem visually) #}
{% set gap_draw = (wg*s - fw_draw)/2 %}

<svg viewBox="0 0 {{canvas_w}} {{canvas_h}}" class="antenna-svg" role="img" aria-label="Antenna parameters diagram" xmlns="http://www.w3.org/2000/svg">
  <!-- background (polos) -->
  <rect x="0" y="0" width="{{canvas_w}}" height="{{canvas_h}}" fill="#ffffff"/>

  <defs>
    <pattern id="grid" width="24" height="24" patternUnits="userSpaceOnUse">
      <path d="M 24 0 L 0 0 0 24" fill="none" class="grid-line"/>
    </pattern>

    <marker id="arrowEnd" markerWidth="10" markerHeight="10" refX="7" refY="3" orient="auto">
      <path d="M0,0 L7,3 L0,6 Z" class="arrow-fill"></path>
    </marker>
    <marker id="arrowStart" markerWidth="10" markerHeight="10" refX="3" refY="3" orient="auto">
      <path d="M7,0 L0,3 L7,6 Z" class="arrow-fill"></path>
    </marker>

    <style type="text/css"><![CDATA[
      svg.antenna-svg .bg-fill { fill: #b0b8c0; fill-opacity: 0.35; }
      svg.antenna-svg .grid-line{ stroke: #000000; stroke-opacity: 0.12; stroke-width: 1; }

      svg.antenna-svg .substrate{
        fill: #ffffff;
        fill-opacity: 0.95;
        stroke: #000000;
        stroke-opacity: 0.65;
        stroke-width: 2;
      }
      svg.antenna-svg .conductor{
        fill: #ffeb00;
        fill-opacity: 0.95;
        stroke: #000000;
        stroke-opacity: 0.45;
        stroke-width: 2;
      }

      svg.antenna-svg .dim{
        stroke: #000000;
        stroke-opacity: 0.70;
        stroke-width: 2;
      }
      svg.antenna-svg .dim-text{
        font: 700 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        fill: #000000;
        fill-opacity: 0.80;
        letter-spacing: .2px;
      }
      svg.antenna-svg .dim-text-sm{
        font: 700 11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        fill: #000000;
        fill-opacity: 0.80;
      }
      svg.antenna-svg .arrow-fill{ fill: #000000; fill-opacity: 0.70; }
    ]]></style>
  </defs>

  <!-- background -->
  <!-- <rect x="0" y="0" width="{{canvas_w}}" height="{{canvas_h}}" class="bg-fill"/>
  <rect x="0" y="0" width="{{canvas_w}}" height="{{canvas_h}}" fill="url(#grid)"/> -->


  <!-- Outer board -->
  <rect x="{{bx}}" y="{{by}}" width="{{wg*s}}" height="{{lg_draw*s}}" class="substrate" />

  <!-- Conductor: patch + stem -->
  <rect x="{{px}}" y="{{py}}" width="{{pw}}" height="{{ph}}" class="conductor"/>
  <rect x="{{fx}}" y="{{fy}}" width="{{fw_draw}}" height="{{fh}}" class="conductor"/>

  <!-- === Dimension lines + TEXT (placeholder before Hitung) === -->

  <!-- Wg (board width) -->
  <line x1="{{bx}}" y1="{{by - 18}}" x2="{{bx + wg*s}}" y2="{{by - 18}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{bx + (wg*s)/2}}" y="{{by - 24}}" class="dim-text" text-anchor="middle">
    {% if labels_on %}Wg = {{ '%.2f' % wg }} mm{% else %}Wg{% endif %}
  </text>

  <!-- Wp (patch width) -->
  <line x1="{{px}}" y1="{{py - 14}}" x2="{{px + pw}}" y2="{{py - 14}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{px + (pw)/2}}" y="{{py - 20}}" class="dim-text-sm" text-anchor="middle">
    {% if labels_on %}Wp = {{ '%.2f' % wp }} mm{% else %}Wp{% endif %}
  </text>

  <!-- LG (right, spans outer height) -->
  <line x1="{{bx + wg*s + 18}}" y1="{{by}}" x2="{{bx + wg*s + 18}}" y2="{{by + lg_draw*s}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{bx + wg*s - 6}}" y="{{by + (lg_draw*s)/2 - 6}}" class="dim-text" text-anchor="middle">
    <tspan x="{{bx + wg*s - 6}}" dy="0">Lg</tspan>
    {% if labels_on %}
    <tspan x="{{bx + wg*s - 6}}" dy="14">{{ '%.2f' % lg }} mm</tspan>
    {% endif %}
  </text>

  <!-- LP (left, spans patch height) -->
  <line x1="{{px - 26}}" y1="{{py}}" x2="{{px - 26}}" y2="{{py + ph}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{px - 13}}" y="{{py + ph/2 - 6}}" class="dim-text" text-anchor="middle">
    <tspan x="{{px - 13}}" dy="0">Lp</tspan>
    {% if labels_on %}
    <tspan x="{{px - 13}}" dy="14">{{ '%.2f' % lp }} mm</tspan>
    {% endif %}
  </text>

  <!-- LF (near stem, spans stem height) -->
  <line x1="{{fx + fw_draw + 18}}" y1="{{fy}}" x2="{{fx + fw_draw + 18}}" y2="{{fy + fh}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{fx + fw_draw + 24}}" y="{{fy + fh/2}}" class="dim-text" dominant-baseline="middle">
    {% if labels_on %}Lf = {{ '%.2f' % lf }} mm{% else %}Lf{% endif %}
  </text>

  <!-- Bottom segmented: WG | WF | WG -->
  {% set yb = by + lg_draw*s + 20 %}

  <!-- left remaining ground: (Wg - Wf)/2 -->
  <line x1="{{bx}}" y1="{{yb}}" x2="{{bx + gap_draw}}" y2="{{yb}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{bx + gap_draw/2}}" y="{{yb + 18}}" class="dim-text-sm" text-anchor="middle">
    {% if labels_on %}(Wg-Wf)/2 = {{ '%.2f' % wg_side }} mm{% else %}(Wg-Wf)/2{% endif %}
  </text>

  <!-- WF (use actual value, but visual width is fw_draw) -->
  <line x1="{{bx + gap_draw}}" y1="{{yb}}" x2="{{bx + gap_draw + fw_draw}}" y2="{{yb}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{bx + gap_draw + fw_draw/2}}" y="{{yb - 8}}" class="dim-text-sm" text-anchor="middle">
    {% if labels_on %}Wf = {{ '%.2f' % wf }} mm{% else %}Wf{% endif %}
  </text>

  <!-- right remaining ground: (Wg - Wf)/2 -->
  <line x1="{{bx + gap_draw + fw_draw}}" y1="{{yb}}" x2="{{bx + wg*s}}" y2="{{yb}}"
        class="dim" marker-start="url(#arrowStart)" marker-end="url(#arrowEnd)"/>
  <text x="{{bx + gap_draw + fw_draw + gap_draw/2}}" y="{{yb + 18}}" class="dim-text-sm" text-anchor="middle">
    {% if labels_on %}(Wg-Wf)/2 = {{ '%.2f' % wg_side }} mm{% else %}(Wg-Wf)/2{% endif %}
  </text>

</svg>
  
