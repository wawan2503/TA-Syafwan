<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator Antena Mikrostrip</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="brand-title">Kalkulator Antena Mikrostrip</div>
        <div class="brand-subtitle">Tampilan mengikuti tugas (Flask)</div>
      </div>
      <div class="topbar-actions">
        <a class="pill pill-link" href="{{ url_for('landing') }}">Home</a>
      </div>
    </div>
  </header>
  <main class="container">
    <!-- LEFT -->
    <section class="panel left">
      <form method="post" action="{{ url_for('calculator') }}" class="card">
        <div class="card-header">
          <h2>Input</h2>
          <p>Parameter tetap sesuai tugas: h, Zo, εr, c</p>
        </div>
        <div class="grid">
          <label class="field">
            <span>Frekuensi (GHz)</span>
            <select name="freq">
              {% for f in freq_options %}
                <option value="{{ f }}" {% if f == selected_freq %}selected{% endif %}>{{ f }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field">
            <span>h (mm)</span>
            <input value="{{ fixed.h_mm }}" readonly />
          </label>
          <label class="field">
            <span>Zo (Ω)</span>
            <input value="{{ fixed.z0 }}" readonly />
          </label>
          <label class="field">
            <span>εr</span>
            <input value="{{ fixed.er }}" readonly />
          </label>
          <label class="field">
            <span>c (m/s)</span>
            <input value="{{ '{:.0e}'.format(fixed.c) }}" readonly />
          </label>
        </div>
        <div class="actions">
          <button class="btn" type="submit">Hitung</button>
        </div>
        {% if error %}
          <div class="alert">{{ error }}</div>
        {% endif %}
        <div class="card-divider"></div>
        <div class="card-header">
          <h2>Output Spesifikasi</h2>
          <p>Wp, Lp, Wg, Lg, Wf, Lf</p>
        </div>
        {% if results %}
          <div class="table">
            <div class="row"><div>Wp (mm)</div><div>{{ '%.2f'|format(results.wp_mm) }}</div></div>
            <div class="row"><div>Lp (mm)</div><div>{{ '%.2f'|format(results.lp_mm) }}</div></div>
            <div class="row"><div>Wg (mm)</div><div>{{ '%.2f'|format(results.wg_mm) }}</div></div>
            <div class="row"><div>Lg (mm)</div><div>{{ '%.2f'|format(results.lg_mm) }}</div></div>
            <div class="row"><div>Wf (mm)</div><div>{{ '%.2f'|format(results.wf_mm) }}</div></div>
            <div class="row"><div>Lf (mm)</div><div>{{ '%.2f'|format(results.lf_mm) }}</div></div>
            <div class="row subtle"><div>εeff (patch)</div><div>{{ '%.4f'|format(results.eps_eff_patch) }}</div></div>
            <div class="row subtle"><div>εeff (feedline)</div><div>{{ '%.4f'|format(results.eps_eff_line) }}</div></div>
          </div>
        {% else %}
          <div class="muted">Klik <b>Hitung</b> untuk menampilkan hasil & gambar.</div>
        {% endif %}
      </form>
      <div class="card chart-card">
        <div class="card-header">
          <h2>Grafik AWR</h2>
          <p>Data diambil langsung dari folder <code>AWR</code> (optimal &amp; sebelum optimal).</p>
        </div>
        <div class="chart-filters">
          <label>
            <span>Mode data</span>
            <select id="awrScenarioSelect"{% if not awr_chart_data.scenario_options %} disabled{% endif %}>
              {% if awr_chart_data.scenario_options %}
                {% for option in awr_chart_data.scenario_options %}
                  <option value="{{ option.key }}"{% if option.key == awr_chart_data.default_scenario %} selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
              {% else %}
                <option>Data belum tersedia</option>
              {% endif %}
            </select>
          </label>
        </div>
        <div class="chart-meta">
          <div>Frekuensi kalkulator: <span id="awrFreqLabel">{{ '%.1f'|format(selected_freq) }} GHz</span></div>
          <div class="chart-note">Grafik mengikuti pilihan frekuensi dan mode di atas.</div>
        </div>
        {% if awr_chart_data.measurement_order %}
          <div class="chart-stack">
            {% for measure_key in awr_chart_data.measurement_order %}
              {% set meta = awr_chart_data.measurements[measure_key] %}
              <div class="chart-panel">
                <div class="chart-panel-header">
                  <h3>{{ meta.title }}</h3>
                  <p>{{ meta.description }}</p>
                </div>
                <div class="chart-holder is-empty" data-chart-holder="awr-{{ measure_key }}">
                  <canvas id="awr-{{ measure_key }}-chart" aria-label="{{ meta.title }}"></canvas>
                  <div class="chart-empty">Data belum tersedia untuk kombinasi ini.</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">Belum ada konfigurasi grafik AWR.</div>
        {% endif %}
      </div>
    </section>
    <!-- RIGHT -->
    <section class="panel right">
      <div class="card">
        <div class="card-header">
          <h2>Visualisasi Antena</h2>
          <p>Gambar langsung tampil, label dimensi (Wp, Lp, Wg, Lg, Wf, Lf) terlihat. Nilai dimensi muncul setelah tombol <b>Hitung</b>.</p>
        </div>
        <div class="viz">
          {% if svg_results %}
            {% with results=svg_results, show_labels=show_svg_labels %}
              {% include "_antenna.svg" %}
            {% endwith %}
          {% else %}
            <div class="viz-placeholder"></div>
          {% endif %}
        </div>
      </div>
      <div class="card chart-card">
        <div class="card-header">
          <h2>Grafik CST</h2>
          <p>Data diambil langsung dari folder <code>CST</code> (optimal &amp; sebelum optimal).</p>
        </div>
        <div class="chart-filters">
          <label>
            <span>Mode data</span>
            <select id="cstScenarioSelect"{% if not cst_chart_data.scenario_options %} disabled{% endif %}>
              {% if cst_chart_data.scenario_options %}
                {% for option in cst_chart_data.scenario_options %}
                  <option value="{{ option.key }}"{% if option.key == cst_chart_data.default_scenario %} selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
              {% else %}
                <option>Data belum tersedia</option>
              {% endif %}
            </select>
          </label>
        </div>
        <div class="chart-meta">
          <div>Frekuensi kalkulator: <span id="cstFreqLabel">{{ '%.1f'|format(selected_freq) }} GHz</span></div>
          <div class="chart-note">Grafik mengikuti pilihan frekuensi dan mode.</div>
        </div>
        {% if cst_chart_data.measurement_order %}
          <div class="chart-stack">
            {% for measure_key in cst_chart_data.measurement_order %}
              {% set meta = cst_chart_data.measurements[measure_key] %}
              <div class="chart-panel">
                <div class="chart-panel-header">
                  <h3>{{ meta.title }}</h3>
                  <p>{{ meta.description }}</p>
                </div>
                <div class="chart-holder is-empty" data-chart-holder="cst-{{ measure_key }}">
                  <canvas id="cst-{{ measure_key }}-chart" aria-label="{{ meta.title }}"></canvas>
                  <div class="chart-empty">Data belum tersedia untuk kombinasi ini.</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">Belum ada konfigurasi grafik CST.</div>
        {% endif %}
      </div>

    </section>
  </main>
  <footer class="footer">
    Flask • Tampilan sesuai tugas
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script>
    (() => {
      if (typeof window.Chart === 'undefined') {
        return;
      }
      const awrDataset = {{ awr_chart_data | tojson | safe }};
      const cstDataset = {{ cst_chart_data | tojson | safe }};
      const freqSelect = document.querySelector('select[name="freq"]');
      const keyFromValue = (value) => {
        if (value === null || value === undefined || value === '') {
          return '';
        }
        const num = Number(value);
        if (Number.isNaN(num)) {
          return String(value).trim();
        }
        return parseFloat(num.toFixed(4)).toString();
      };
      const formatAxisNumber = (value) => {
        const num = Number(value);
        if (Number.isNaN(num)) {
          return value;
        }
        return parseFloat(num.toFixed(2)).toString();
      };
      const initChartGroup = ({ dataset, scenarioSelectId, freqLabelId, groupKey }) => {
        if (!dataset || !Array.isArray(dataset.measurement_order) || dataset.measurement_order.length === 0) {
          return;
        }
        if (!dataset.scenarios || Object.keys(dataset.scenarios).length === 0) {
          return;
        }
        const scenarioSelect = document.getElementById(scenarioSelectId);
        if (!scenarioSelect) {
          return;
        }
        const freqLabel = document.getElementById(freqLabelId);
        const charts = {};
        const getScenarioEntry = () => {
          const key = scenarioSelect.value || dataset.default_scenario;
          return dataset.scenarios[key] || dataset.scenarios[dataset.default_scenario];
        };
        const resolveFreqEntry = (scenarioEntry) => {
          if (!scenarioEntry) {
            return null;
          }
          const requestedKey = keyFromValue(freqSelect ? freqSelect.value : dataset.default_freq_key);
          let entry = scenarioEntry.frequencies[requestedKey];
          if (!entry) {
            const fallbackKey = scenarioEntry.default_freq_key;
            entry = fallbackKey ? scenarioEntry.frequencies[fallbackKey] : undefined;
          }
          if (!entry) {
            const values = Object.values(scenarioEntry.frequencies);
            entry = values.length ? values[0] : null;
          }
          return entry || null;
        };
        const buildOptions = (meta) => ({
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const value = typeof ctx.parsed.y === 'number' ? ctx.parsed.y.toFixed(3) : ctx.parsed.y;
                  return `${meta.y_label || 'Y'}: ${value}`;
                },
              },
            },
          },
          scales: {
            x: {
              title: { display: true, text: meta.x_label || 'X' },
              grid: { color: 'rgba(15,23,42,0.12)' },
            },
            y: {
              title: { display: true, text: meta.y_label || 'Y' },
              grid: { color: 'rgba(15,23,42,0.12)' },
            },
          },
        });
        const updateCharts = () => {
          const scenarioEntry = getScenarioEntry();
          const freqEntry = resolveFreqEntry(scenarioEntry);
          if (freqLabel) {
            freqLabel.textContent = freqEntry && freqEntry.label ? freqEntry.label : '-';
          }
          dataset.measurement_order.forEach((measureKey) => {
            const meta = dataset.measurements?.[measureKey];
            const holder = document.querySelector(`[data-chart-holder="${groupKey}-${measureKey}"]`);
            const canvas = document.getElementById(`${groupKey}-${measureKey}-chart`);
            if (!meta || !holder || !canvas) {
              return;
            }
            const measurementEntry = freqEntry?.measurements?.[measureKey];
            if (!measurementEntry || !Array.isArray(measurementEntry.x) || measurementEntry.x.length === 0) {
              holder.classList.add('is-empty');
              if (charts[measureKey]) {
                charts[measureKey].destroy();
                charts[measureKey] = null;
              }
              return;
            }
            holder.classList.remove('is-empty');
            const data = {
              labels: measurementEntry.x.map((value) => formatAxisNumber(value)),
              datasets: [{
                label: meta.title || 'Data',
                data: measurementEntry.y,
                borderColor: meta.color || 'rgba(37,99,235,1)',
                backgroundColor: meta.background || 'rgba(37,99,235,0.15)',
                borderWidth: 2,
                tension: typeof meta.tension === 'number' ? meta.tension : 0.25,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 4,
                pointHitRadius: 8,
              }],
            };
            const options = buildOptions(meta);
            if (!charts[measureKey]) {
              charts[measureKey] = new Chart(canvas, { type: 'line', data, options });
            } else {
              charts[measureKey].data = data;
              charts[measureKey].options = options;
              charts[measureKey].update();
            }
          });
        };
        scenarioSelect.addEventListener('change', updateCharts);
        if (freqSelect) {
          freqSelect.addEventListener('change', updateCharts);
        }
        updateCharts();
      };
      initChartGroup({ dataset: awrDataset, scenarioSelectId: 'awrScenarioSelect', freqLabelId: 'awrFreqLabel', groupKey: 'awr' });
      initChartGroup({ dataset: cstDataset, scenarioSelectId: 'cstScenarioSelect', freqLabelId: 'cstFreqLabel', groupKey: 'cst' });
    })();
  </script>

</body>
</html>
